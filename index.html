<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>演唱會售票網站</title>
<style>
  :root {
    --primary-color: #ff4081;
    --secondary-color: #3f51b5;
    --accent-color: #00bcd4;
    --background-color: #f5f5f5;
    --text-color: #333;
    --border-radius: 8px;
    --max-width: 900px;
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: "Noto Sans TC", Arial, sans-serif;
    background: var(--background-color);
    margin: 0;
    padding: 0;
    color: var(--text-color);
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  #app {
    background: white;
    margin: 20px;
    max-width: var(--max-width);
    width: 100%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: var(--border-radius);
    display: flex;
    flex-direction: column;
    min-height: 600px;
  }
  header {
    background: var(--secondary-color);
    color: white;
    padding: 1rem;
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    margin: 0;
    font-weight: 600;
    font-size: 1.5rem;
  }
  main {
    flex: 1;
    padding: 1.5rem 2rem;
    overflow-y: auto;
  }
  button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: var(--accent-color);
  }
  input, select {
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: var(--border-radius);
    width: 100%;
    margin-top: 0.25rem;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }
  form {
    max-width: 400px;
    margin: 2rem auto;
  }
  .logout-btn {
    background: transparent;
    border: 1px solid white;
    padding: 0.4rem 1rem;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .logout-btn:hover {
    background: white;
    color: var(--secondary-color);
  }
  h2 {
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 0.3rem;
    margin-top: 0;
  }
  .user-list, .concert-list, .tickets-list, .venue-list, .role-list {
    list-style-type: none;
    padding: 0;
    margin-top: 0.5rem;
  }
  .user-list li, .concert-list li, .tickets-list li, .venue-list li, .role-list li {
    background: #fafafa;
    border: 1px solid #ddd;
    margin-bottom: 0.5rem;
    padding: 0.7rem 1rem;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .flex-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  .flex-grow {
    flex-grow: 1;
  }
  .small-btn {
    background: #e91e63;
    padding: 0.3rem 0.6rem;
    font-size: 0.9rem;
  }
  .small-btn:hover {
    background: #ad1457;
  }
  .info {
    font-size: 0.9rem;
    color: #555;
  }
  .error {
    color: #e53935;
    font-weight: 600;
    margin-top: 0.25rem;
  }
  .success {
    color: #43a047;
    font-weight: 600;
    margin-top: 0.25rem;
  }
  @media (max-width: 600px) {
    main {
      padding: 1rem;
    }
    form {
      max-width: 100%;
      margin: 1rem 0;
    }
  }
  /* Modal styles */
  .modal-overlay {
    position: fixed;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-box {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 400px;
    width: 90%;
    box-sizing: border-box;
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>演唱會售票網站</h1>
    <button id="logoutBtn" class="logout-btn" style="display:none;">登出</button>
  </header>
  <main id="mainContent">
    <!-- Content generated by JS -->
  </main>
</div>

<script>
  // Users: username, password, roles[]
  const users = [
    {username: 'admin', password: 'admin123', roles: ['admin']},
    {username: 'org1', password: 'org123', roles: ['organizer']},
    {username: 'org2', password: 'org234', roles: ['organizer']},
    {username: 'user1', password: 'user123', roles: ['spectator']},
    {username: 'user2', password: 'user234', roles: ['spectator']},
    // Multi-role user for testing
    {username: 'multiuser', password: 'multi123', roles: ['admin','organizer']}
  ];

  // Venues database: id, name, location, capacity
  let venues = [
    {id:1, name:'台北小巨蛋', location: '台北市信義區', capacity: 15000},
    {id:2, name:'高雄巨蛋', location: '高雄市左營區', capacity: 13000}
  ];

  // Concerts database: id, title, date, venueId, ticketsAvailable, ticketsSold, price
  let concerts = [
    {id: 1, title: '流行音樂演唱會', date: '2024-09-15', venueId: 1, ticketsAvailable: 100, ticketsSold: 0, price: 1500},
    {id: 2, title: '搖滾之夜', date: '2024-10-01', venueId: 2, ticketsAvailable: 200, ticketsSold: 0, price: 1200}
  ];

  // Tickets purchased: {username, concertId, quantity}
  let tickets = [];

  // Current logged in user and selected role
  let currentUser = null;
  let currentRole = null;

  const app = document.getElementById('app');
  const mainContent = document.getElementById('mainContent');
  const logoutBtn = document.getElementById('logoutBtn');

  // Persistent storage keys
  const STORAGE_KEYS = {
    VENUES: 'venues',
    CONCERTS: 'concerts',
    TICKETS: 'tickets',
    CURRENT_USER: 'currentUser',
    CURRENT_ROLE: 'currentRole'
  };

  // Utility: save/load data from localStorage
  function saveData() {
    localStorage.setItem(STORAGE_KEYS.VENUES, JSON.stringify(venues));
    localStorage.setItem(STORAGE_KEYS.CONCERTS, JSON.stringify(concerts));
    localStorage.setItem(STORAGE_KEYS.TICKETS, JSON.stringify(tickets));
  }
  function loadData() {
    const savedVenues = localStorage.getItem(STORAGE_KEYS.VENUES);
    if (savedVenues) venues = JSON.parse(savedVenues);

    const savedConcerts = localStorage.getItem(STORAGE_KEYS.CONCERTS);
    if (savedConcerts) concerts = JSON.parse(savedConcerts);

    const savedTickets = localStorage.getItem(STORAGE_KEYS.TICKETS);
    if (savedTickets) tickets = JSON.parse(savedTickets);
  }

  // Save login & role to localStorage
  function saveLogin() {
    localStorage.setItem(STORAGE_KEYS.CURRENT_USER, JSON.stringify(currentUser));
    localStorage.setItem(STORAGE_KEYS.CURRENT_ROLE, currentRole);
  }
  // Load login & role
  function loadLogin() {
    const savedUser = localStorage.getItem(STORAGE_KEYS.CURRENT_USER);
    if (savedUser) currentUser = JSON.parse(savedUser);
    const savedRole = localStorage.getItem(STORAGE_KEYS.CURRENT_ROLE);
    if (savedRole) currentRole = savedRole;
  }
  // Clear login state
  function clearLogin() {
    localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
    localStorage.removeItem(STORAGE_KEYS.CURRENT_ROLE);
    currentUser = null;
    currentRole = null;
  }

  // Render login form (username + password)
  function renderLogin() {
    logoutBtn.style.display = 'none';
    mainContent.innerHTML = `
      <form id="loginForm">
        <h2>登入</h2>
        <label for="username">使用者名稱</label>
        <input type="text" id="username" placeholder="輸入使用者名稱" required />
        <label for="password">密碼</label>
        <input type="password" id="password" placeholder="輸入密碼" required />
        <button type="submit" style="margin-top:1rem;">登入</button>
        <button type="button" id="showRegisterBtn" style="margin-top:1rem; margin-left:0.5rem; background:var(--secondary-color);">註冊</button>
        <button type="button" id="forgotPwdBtn" style="margin-top:1rem; margin-left:0.5rem; background:#00bcd4;">忘記密碼</button>
        <p id="loginError" class="error" style="display:none;"></p>
      </form>
    `;

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      const user = users.find(u => u.username === username && u.password === password);
      const errorEl = document.getElementById('loginError');
      if (user) {
        currentUser = user;
        errorEl.style.display = 'none';
        currentRole = null;
        saveLogin();
        loadData();
        logoutBtn.style.display = 'inline-block';
        if(user.roles.length === 1){
          // If only one role, auto select
          currentRole = user.roles[0];
          saveLogin();
          renderDashboard();
        } else {
          renderRoleSelection();
        }
      } else {
        errorEl.textContent = '帳號或密碼錯誤，請重新輸入';
        errorEl.style.display = 'block';
      }
    });

    document.getElementById('showRegisterBtn').onclick = renderRegister;
    document.getElementById('forgotPwdBtn').onclick = renderForgotPassword;
  }

  // 忘記密碼流程
  function renderForgotPassword() {
    logoutBtn.style.display = 'none';
    mainContent.innerHTML = `
      <form id="forgotPwdForm">
        <h2>忘記密碼</h2>
        <label for="fpUsername">使用者名稱</label>
        <input type="text" id="fpUsername" placeholder="請輸入帳號" required />
        <label for="fpPhone">手機號碼</label>
        <input type="text" id="fpPhone" placeholder="請輸入手機號碼" required />
        <button type="button" id="getCodeBtn" style="margin-top:1rem;">取得驗證碼</button>
        <div id="codeSection" style="display:none; margin-top:1rem;">
          <label for="fpCode">驗證碼</label>
          <input type="text" id="fpCode" maxlength="4" placeholder="輸入4位數驗證碼" required />
          <label for="fpNewPwd">新密碼</label>
          <input type="password" id="fpNewPwd" placeholder="輸入新密碼" required />
          <button type="submit" style="margin-top:1rem;">重設密碼</button>
        </div>
        <button type="button" id="backToLoginBtn" style="margin-top:1rem; margin-left:0.5rem; background:var(--secondary-color);">返回登入</button>
        <p id="fpError" class="error" style="display:none;"></p>
        <p id="fpSuccess" class="success" style="display:none;"></p>
      </form>
    `;

    let sentCode = null;

    document.getElementById('getCodeBtn').onclick = function() {
      const username = document.getElementById('fpUsername').value.trim();
      const phone = document.getElementById('fpPhone').value.trim();
      const err = document.getElementById('fpError');
      err.style.display = 'none';

      if (!username || !phone) {
        err.textContent = '請輸入帳號與手機號碼';
        err.style.display = 'block';
        return;
      }
      // 檢查帳號是否存在
      const user = users.find(u => u.username === username);
      if (!user) {
        err.textContent = '帳號不存在';
        err.style.display = 'block';
        return;
      }
      // 產生4位數驗證碼（實際驗證時只要4位數即可）
      sentCode = ('' + Math.floor(1000 + Math.random() * 9000));
      document.getElementById('codeSection').style.display = 'block';
      err.style.display = 'none';
      alert('驗證碼已發送（測試用：' + sentCode + '，實際輸入任意4位數即可通過）');
    };

    document.getElementById('forgotPwdForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('fpUsername').value.trim();
      const code = document.getElementById('fpCode').value.trim();
      const newPwd = document.getElementById('fpNewPwd').value;
      const err = document.getElementById('fpError');
      const succ = document.getElementById('fpSuccess');
      err.style.display = 'none';
      succ.style.display = 'none';

      if (!code || code.length !== 4 || !/^\d{4}$/.test(code)) {
        err.textContent = '請輸入4位數驗證碼';
        err.style.display = 'block';
        return;
      }
      if (!newPwd) {
        err.textContent = '請輸入新密碼';
        err.style.display = 'block';
        return;
      }
      // 只要4位數即可通過
      const user = users.find(u => u.username === username);
      if (!user) {
        err.textContent = '帳號不存在';
        err.style.display = 'block';
        return;
      }
      user.password = newPwd;
      succ.textContent = '密碼重設成功，請使用新密碼登入';
      succ.style.display = 'block';
      setTimeout(renderLogin, 1200);
    });

    document.getElementById('backToLoginBtn').onclick = renderLogin;
  }

  // 新增：註冊表單
  function renderRegister() {
    logoutBtn.style.display = 'none';
    mainContent.innerHTML = `
      <form id="registerForm">
        <h2>註冊新帳號</h2>
        <label for="regUsername">使用者名稱</label>
        <input type="text" id="regUsername" placeholder="輸入使用者名稱" required />
        <label for="regPassword">密碼</label>
        <input type="password" id="regPassword" placeholder="輸入密碼" required />
        <label for="regPassword2">確認密碼</label>
        <input type="password" id="regPassword2" placeholder="再次輸入密碼" required />
        <button type="submit" style="margin-top:1rem;">註冊</button>
        <button type="button" id="backToLoginBtn" style="margin-top:1rem; margin-left:0.5rem; background:var(--secondary-color);">返回登入</button>
        <p id="registerError" class="error" style="display:none;"></p>
        <p id="registerSuccess" class="success" style="display:none;"></p>
      </form>
    `;
    document.getElementById('registerForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const password2 = document.getElementById('regPassword2').value;
      const err = document.getElementById('registerError');
      const succ = document.getElementById('registerSuccess');
      err.style.display = 'none';
      succ.style.display = 'none';

      if (!username || !password || !password2) {
        err.textContent = '所有欄位皆為必填';
        err.style.display = 'block';
        return;
      }
      if (password !== password2) {
        err.textContent = '兩次密碼輸入不一致';
        err.style.display = 'block';
        return;
      }
      if (users.find(u => u.username === username)) {
        err.textContent = '使用者名稱已被使用';
        err.style.display = 'block';
        return;
      }
      // 新增帳號（角色為觀眾）
      const newUser = {username, password, roles: ['spectator']};
      users.push(newUser);
      succ.textContent = '註冊成功，將自動登入...';
      succ.style.display = 'block';
      // 自動登入
      setTimeout(() => {
        currentUser = newUser;
        currentRole = 'spectator';
        saveLogin();
        renderDashboard();
      }, 800);
    });
    document.getElementById('backToLoginBtn').onclick = renderLogin;
  }

  // Role selection UI after login if multiple roles
  function renderRoleSelection() {
    if(!currentUser) {
      renderLogin();
      return;
    }
    logoutBtn.style.display = 'inline-block';
    mainContent.innerHTML = `
      <h2>選擇身分組</h2>
      <ul class="role-list" id="roleList"></ul>
    `;
    const ul = document.getElementById('roleList');
    currentUser.roles.forEach(role => {
      const li = document.createElement('li');
      const roleName = roleNameDisplay(role);
      const btn = document.createElement('button');
      btn.textContent = roleName;
      btn.style.flexGrow = '1';
      btn.onclick = () => {
        currentRole = role;
        saveLogin();
        renderDashboard();
      };
      li.appendChild(btn);
      ul.appendChild(li);
    });
  }

  function roleNameDisplay(role){
    switch(role){
      case 'admin': return '管理者';
      case 'organizer': return '主辦方';
      case 'spectator': return '觀眾';
      default: return role;
    }
  }

  // Render dashboard based on role
  function renderDashboard() {
    if(!currentUser || !currentRole){
      renderLogin();
      return;
    }
    switch(currentRole){
      case 'admin':
        renderAdminDashboard();
        break;
      case 'organizer':
        renderOrganizerDashboard();
        break;
      case 'spectator':
        renderSpectatorDashboard();
        break;
      default:
        mainContent.innerHTML = `<p>未知角色：${currentRole}</p>`;
    }
  }

  // ------------------ Admin dashboard ----------------------
  // Admin: manage venues, ticketing, accounting, users

  function renderAdminDashboard(){
    mainContent.innerHTML = `
    <h2>管理者控制台</h2>
    <nav style="margin-bottom: 1rem;">
      <button id="adminUsersBtn">使用者帳號管理</button>
      <button id="adminVenuesBtn">場地管理</button>
      <button id="adminTicketsBtn">票務管理</button>
      <button id="adminAccountingBtn">帳務管理</button>
      <button id="adminRefundBtn">退票審核</button>
    </nav>
    <section id="adminContent">
    </section>
    `;
    document.getElementById('adminUsersBtn').onclick = () => renderAdminUsers();
    document.getElementById('adminVenuesBtn').onclick = () => renderAdminVenues();
    document.getElementById('adminTicketsBtn').onclick = () => renderAdminTickets();
    document.getElementById('adminAccountingBtn').onclick = () => renderAdminAccounting();
    document.getElementById('adminRefundBtn').onclick = () => renderRefundReview();

    // Default show users
    renderAdminUsers();
  }

  // Admin manage users
  function renderAdminUsers(){
    const container = document.getElementById('adminContent');
    container.innerHTML = `
      <h3>使用者帳號管理</h3>
      <ul class="user-list" id="userList"></ul>
      <form id="addUserForm" style="margin-top:1rem; max-width:400px;">
        <h4>新增使用者</h4>
        <label for="newUsername">使用者名稱</label>
        <input type="text" id="newUsername" required />
        <label for="newPassword">密碼</label>
        <input type="password" id="newPassword" required />
        <label for="newRoles">身分組</label>
        <select id="newRoles" multiple required style="height: 120px;">
          <option value="admin">管理者</option>
          <option value="organizer">主辦方</option>
          <option value="spectator">觀眾</option>
        </select>
        <p style="font-size:0.85rem; color:#666; margin-top:0.25rem;">(可多選，按 Ctrl/Cmd 多選身分組)</p>
        <button type="submit" style="margin-top:1rem;">新增使用者</button>
        <p id="addUserMsg" class="success" style="display:none;"></p>
        <p id="addUserError" class="error" style="display:none;"></p>
      </form>
    `;
    renderUserListAdmin();
    document.getElementById('addUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const select = document.getElementById('newRoles');
      const roles = Array.from(select.selectedOptions).map(o => o.value);
      const msg = document.getElementById('addUserMsg');
      const err = document.getElementById('addUserError');
      msg.style.display = 'none';
      err.style.display = 'none';

      if(users.find(u => u.username === username)) {
        err.textContent = '使用者名稱已被使用';
        err.style.display = 'block';
        return;
      }
      if(!username || !password || roles.length===0) {
        err.textContent = '所有欄位皆為必填且需選擇身分組';
        err.style.display = 'block';
        return;
      }
      users.push({username, password, roles});
      msg.textContent = '新增成功！';
      msg.style.display = 'block';
      e.target.reset();
      renderUserListAdmin();
    });
  }
  function renderUserListAdmin(){
    const ul = document.getElementById('userList');
    ul.innerHTML = '';
    users.forEach(u => {
      const li = document.createElement('li');
      const roleLabels = u.roles.map(r => roleNameDisplay(r)).join(', ');
      li.textContent = `${u.username} (${roleLabels})`;
      if(u.username !== currentUser.username){
        const btn = document.createElement('button');
        btn.className = 'small-btn';
        btn.textContent = '刪除';
        btn.onclick = () => {
          if(confirm(`確定要刪除使用者 ${u.username} 嗎？`)){
            const idx = users.findIndex(us => us.username === u.username);
            if(idx !== -1){
              users.splice(idx,1);
              renderUserListAdmin();
            }
          }
        };
        li.appendChild(btn);
      }
      ul.appendChild(li);
    });
  }

  // Admin manage venues
  function renderAdminVenues(){
    const container = document.getElementById('adminContent');
    container.innerHTML = `
      <h3>場地管理</h3>
      <ul class="venue-list" id="venueList"></ul>
      <form id="addVenueForm" style="margin-top:1rem; max-width:400px;">
        <h4>新增場地</h4>
        <label for="venueName">場地名稱</label>
        <input type="text" id="venueName" required />
        <label for="venueLocation">地點</label>
        <input type="text" id="venueLocation" required />
        <label for="venueCapacity">容量</label>
        <input type="number" id="venueCapacity" min="1" required />
        <button type="submit" style="margin-top:1rem;">新增場地</button>
        <p id="addVenueMsg" class="success" style="display:none;"></p>
        <p id="addVenueError" class="error" style="display:none;"></p>
      </form>
    `;
    renderVenueList();
    document.getElementById('addVenueForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('venueName').value.trim();
      const location = document.getElementById('venueLocation').value.trim();
      const capacity = parseInt(document.getElementById('venueCapacity').value);
      const msg = document.getElementById('addVenueMsg');
      const err = document.getElementById('addVenueError');
      msg.style.display = 'none';
      err.style.display = 'none';

      if(!name || !location || !capacity || capacity < 1) {
        err.textContent = '所有欄位皆為必填且容量需大於0';
        err.style.display = 'block';
        return;
      }
      const id = venues.length ? Math.max(...venues.map(v=>v.id))+1 : 1;
      venues.push({id, name, location, capacity});
      saveData();
      msg.textContent = '新增場地成功！';
      msg.style.display = 'block';
      e.target.reset();
      renderVenueList();
    });
  }
  function renderVenueList(){
    const ul = document.getElementById('venueList');
    ul.innerHTML = '';
    venues.forEach(v => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${v.name}</strong> <br/>
          地點: ${v.location} | 容量: ${v.capacity}
        </div>
      `;
      const delBtn = document.createElement('button');
      delBtn.className = 'small-btn';
      delBtn.textContent = '刪除';
      delBtn.onclick = () => {
        if(confirm(`確定要刪除場地「${v.name}」嗎？此操作不會自動移除相關演唱會。`)) {
          const idx = venues.findIndex(venue => venue.id === v.id);
          if(idx !== -1){
            venues.splice(idx,1);
            saveData();
            renderVenueList();
          }
        }
      };
      li.appendChild(delBtn);
      ul.appendChild(li);
    });
  }

  // Admin manage tickets - show concerts, possibly allow editing concert ticket info
  function renderAdminTickets(){
    const container = document.getElementById('adminContent');
    container.innerHTML = `
      <h3>票務管理</h3>
      <ul class="concert-list" id="concertList"></ul>
      <form id="addConcertForm" style="margin-top:1rem; max-width:400px;">
        <h4>新增演唱會</h4>
        <label for="concertTitle">標題</label>
        <input type="text" id="concertTitle" required />
        <label for="concertDate">日期</label>
        <input type="date" id="concertDate" required />
        <label for="concertVenue">場地</label>
        <select id="concertVenue" required>
          <option value="" disabled selected>請選擇場地</option>
        </select>
        <label for="concertTickets">可售票數量</label>
        <input type="number" id="concertTickets" min="1" required />
        <label for="concertPrice">票價 (NT$)</label>
        <input type="number" id="concertPrice" min="0" required />
        <button type="submit" style="margin-top:1rem;">新增演唱會</button>
        <p id="addConcertMsg" class="success" style="display:none;"></p>
        <p id="addConcertError" class="error" style="display:none;"></p>
      </form>
    `;
    renderConcertVenueOptions();
    renderConcertListAdmin();
    document.getElementById('addConcertForm').addEventListener('submit', e=>{
      e.preventDefault();
      const title = document.getElementById('concertTitle').value.trim();
      const date = document.getElementById('concertDate').value;
      const venueId = parseInt(document.getElementById('concertVenue').value);
      const ticketsAvailable = parseInt(document.getElementById('concertTickets').value);
      const price = parseInt(document.getElementById('concertPrice').value);
      const msg = document.getElementById('addConcertMsg');
      const err = document.getElementById('addConcertError');
      msg.style.display = 'none';
      err.style.display = 'none';

      if(!title || !date || !venueId || !ticketsAvailable || isNaN(price)) {
        err.textContent = '所有欄位皆為必填且需有效';
        err.style.display = 'block';
        return;
      }
      const venue = venues.find(v => v.id === venueId);
      if(!venue){
        err.textContent = '選擇的場地不存在';
        err.style.display = 'block';
        return;
      }
      // Validate ticketsAvailable not exceed venue capacity
      if(ticketsAvailable > venue.capacity){
        err.textContent = `可售票數量不可超過場地容量 (${venue.capacity})`;
        err.style.display = 'block';
        return;
      }

      const id = concerts.length ? Math.max(...concerts.map(c => c.id)) + 1 : 1;
      concerts.push({id, title, date, venueId, ticketsAvailable, ticketsSold: 0, price});
      saveData();
      msg.textContent = '新增演唱會成功！';
      msg.style.display = 'block';
      e.target.reset();
      renderConcertListAdmin();
    });
  }
  function renderConcertVenueOptions(){
    const select = document.getElementById('concertVenue');
    select.innerHTML = `<option value="" disabled selected>請選擇場地</option>`;
    venues.forEach(v=>{
      const option = document.createElement('option');
      option.value = v.id;
      option.textContent = `${v.name} (${v.location}) 容量:${v.capacity}`;
      select.appendChild(option);
    });
  }
  function renderConcertListAdmin(){
    const ul = document.getElementById('concertList');
    ul.innerHTML = '';
    concerts.forEach(c => {
      const venue = venues.find(v => v.id === c.venueId);
      const venueName = venue ? venue.name : '已刪除場地';
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${c.title}</strong><br/>
          日期: ${c.date} | 場地: ${venueName} <br/>
          票價: NT$${c.price} | 可售: ${c.ticketsAvailable} | 已賣: ${c.ticketsSold}
        </div>
      `;
      const delBtn = document.createElement('button');
      delBtn.className = 'small-btn';
      delBtn.textContent = '刪除';
      delBtn.onclick = () => {
        if(confirm(`確定刪除演唱會「${c.title}」？此操作不會自動退還已賣票券。`)){
          const idx = concerts.findIndex(con => con.id === c.id);
          if(idx !== -1){
            concerts.splice(idx,1);
            saveData();
            renderConcertListAdmin();
          }
        }
      };
      li.appendChild(delBtn);
      ul.appendChild(li);
    });
  }

  // Admin accounting: show summary of tickets sold and revenue
  function renderAdminAccounting(){
    const container = document.getElementById('adminContent');
    container.innerHTML = `<h3>帳務管理</h3>
      <table style="width:100%; border-collapse: collapse;" border="1" cellpadding="5" cellspacing="0">
        <thead>
          <tr style="background: var(--primary-color); color:white;">
            <th>演唱會</th>
            <th>票價 (NT$)</th>
            <th>已售票數</th>
            <th>收入 (NT$)</th>
          </tr>
        </thead>
        <tbody id="accountingBody"></tbody>
        <tfoot style="font-weight:bold;">
          <tr>
            <td colspan="3" style="text-align:right;">總收入：</td>
            <td id="totalRevenue">NT$0</td>
          </tr>
        </tfoot>
      </table>`;
    const tbody = document.getElementById('accountingBody');
    tbody.innerHTML = '';
    let total = 0;
    concerts.forEach(c => {
      const revenue = c.ticketsSold * c.price;
      total += revenue;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.title}</td>
        <td>${c.price}</td>
        <td>${c.ticketsSold}</td>
        <td>${revenue}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('totalRevenue').textContent = `NT$${total}`;
  }

  // ------------------ Organizer dashboard ----------------------
  // Organizer: manage tickets and accounting (similar to admin but less features)

  function renderOrganizerDashboard(){
    mainContent.innerHTML = `
    <h2>主辦方控制台</h2>
    <nav style="margin-bottom: 1rem;">
      <button id="orgTicketsBtn">票務管理</button>
      <button id="orgAccountingBtn">帳務管理</button>
    </nav>
    <section id="organizerContent"></section>
    `;
    document.getElementById('orgTicketsBtn').onclick = () => renderOrgTickets();
    document.getElementById('orgAccountingBtn').onclick = () => renderOrgAccounting();

    // Default show tickets
    renderOrgTickets();
  }

  // Organizer tickets management: show concerts and add
  function renderOrgTickets(){
    const container = document.getElementById('organizerContent');
    container.innerHTML = `
      <h3>票務管理</h3>
      <ul class="concert-list" id="concertList"></ul>
      <form id="addConcertForm" style="margin-top:1rem; max-width:400px;">
        <h4>新增演唱會</h4>
        <label for="concertTitle">標題</label>
        <input type="text" id="concertTitle" required />
        <label for="concertDate">日期</label>
        <input type="date" id="concertDate" required />
        <label for="concertVenue">場地</label>
        <select id="concertVenue" required>
          <option value="" disabled selected>請選擇場地</option>
        </select>
        <label for="concertTickets">可售票數量</label>
        <input type="number" id="concertTickets" min="1" required />
        <label for="concertPrice">票價 (NT$)</label>
        <input type="number" id="concertPrice" min="0" required />
        <button type="submit" style="margin-top:1rem;">新增演唱會</button>
        <p id="addConcertMsg" class="success" style="display:none;"></p>
        <p id="addConcertError" class="error" style="display:none;"></p>
      </form>
    `;
    renderConcertVenueOptions();
    renderConcertListOrganizer();
    document.getElementById('addConcertForm').addEventListener('submit', e=>{
      e.preventDefault();
      const title = document.getElementById('concertTitle').value.trim();
      const date = document.getElementById('concertDate').value;
      const venueId = parseInt(document.getElementById('concertVenue').value);
      const ticketsAvailable = parseInt(document.getElementById('concertTickets').value);
      const price = parseInt(document.getElementById('concertPrice').value);
      const msg = document.getElementById('addConcertMsg');
      const err = document.getElementById('addConcertError');
      msg.style.display = 'none';
      err.style.display = 'none';

      if(!title || !date || !venueId || !ticketsAvailable || isNaN(price)) {
        err.textContent = '所有欄位皆為必填且需有效';
        err.style.display = 'block';
        return;
      }
      const venue = venues.find(v => v.id === venueId);
      if(!venue){
        err.textContent = '選擇的場地不存在';
        err.style.display = 'block';
        return;
      }
      if(ticketsAvailable > venue.capacity){
        err.textContent = `可售票數量不可超過場地容量 (${venue.capacity})`;
        err.style.display = 'block';
        return;
      }

      const id = concerts.length ? Math.max(...concerts.map(c => c.id))+1 : 1;
      concerts.push({id, title, date, venueId, ticketsAvailable, ticketsSold: 0, price});
      saveData();
      msg.textContent = '新增演唱會成功！';
      msg.style.display = 'block';
      e.target.reset();
      renderConcertListOrganizer();
    });
  }
  function renderConcertListOrganizer(){
    const ul = document.getElementById('concertList');
    ul.innerHTML = '';
    concerts.forEach(c=>{
      const venue = venues.find(v=>v.id===c.venueId);
      const venueName = venue ? venue.name : '已刪除場地';
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${c.title}</strong><br/>
          日期: ${c.date} | 場地: ${venueName} <br/>
          票價: NT$${c.price} | 可售: ${c.ticketsAvailable} | 已賣: ${c.ticketsSold}
        </div>
      `;
      ul.appendChild(li);
    });
  }
  // Organizer accounting - similar to admin accounting but no edit
  function renderOrgAccounting(){
    mainContent.querySelector('#organizerContent').innerHTML = `<h3>帳務管理</h3>
      <table style="width:100%; border-collapse: collapse;" border="1" cellpadding="5" cellspacing="0">
        <thead>
          <tr style="background: var(--primary-color); color:white;">
            <th>演唱會</th>
            <th>票價 (NT$)</th>
            <th>已售票數</th>
            <th>收入 (NT$)</th>
          </tr>
        </thead>
        <tbody id="orgAccountingBody"></tbody>
        <tfoot style="font-weight:bold;">
          <tr>
            <td colspan="3" style="text-align:right;">總收入：</td>
            <td id="orgTotalRevenue">NT$0</td>
          </tr>
        </tfoot>
      </table>`;
    const tbody = document.getElementById('orgAccountingBody');
    tbody.innerHTML = '';
    let total = 0;
    concerts.forEach(c=>{
      const revenue = c.ticketsSold * c.price;
      total += revenue;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.title}</td>
        <td>${c.price}</td>
        <td>${c.ticketsSold}</td>
        <td>${revenue}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('orgTotalRevenue').textContent = `NT$${total}`;
  }

  // ------------------ Spectator dashboard ----------------------
  // Spectator: buy tickets, refund tickets

  function renderSpectatorDashboard(){
    mainContent.innerHTML = `
      <h2>觀眾專區</h2>
      <section>
        <h3>演唱會列表</h3>
        <ul class="concert-list" id="spectatorConcertList"></ul>
      </section>
      <section style="margin-top: 2rem;">
        <h3>我的票券</h3>
        <ul class="tickets-list" id="myTicketsList"></ul>
      </section>
    `;
    renderConcertsForSpectator();
    renderMyTickets();
  }

  // Show concerts with buy button if available
  function renderConcertsForSpectator(){
    const ul = document.getElementById('spectatorConcertList');
    ul.innerHTML = '';
    concerts.forEach(c => {
      const ticketsLeft = c.ticketsAvailable - c.ticketsSold;
      const venue = venues.find(v => v.id === c.venueId);
      const venueName = venue ? venue.name : '已刪除場地';
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${c.title}</strong><br/>
          日期: ${c.date} | 場地: ${venueName} <br/>
          票價: NT$${c.price} | 剩餘票數: ${ticketsLeft}
        </div>
      `;
      if(ticketsLeft > 0){
        const buyBtn = document.createElement('button');
        buyBtn.textContent = '購買';
        buyBtn.onclick = ()=> showBuyTicketModal(c);
        li.appendChild(buyBtn);
      } else {
        const soldOut = document.createElement('span');
        soldOut.textContent = '已售完';
        soldOut.style.color = '#e53935';
        soldOut.style.fontWeight = '600';
        soldOut.style.marginLeft = '0.5rem';
        li.appendChild(soldOut);
      }
      ul.appendChild(li);
    });
  }

  // Show user ticket list with refund button
  function renderMyTickets(){
    const ul = document.getElementById('myTicketsList');
    ul.innerHTML = '';
    const myTickets = tickets.filter(t => t.username === currentUser.username);
    if(myTickets.length === 0){
      ul.innerHTML = '<li>目前尚無票券</li>';
      return;
    }
    myTickets.forEach(t => {
      const concert = concerts.find(c => c.id === t.concertId);
      if(!concert) return;
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${concert.title}</strong><br/>
          日期: ${concert.date} | 場地: ${venues.find(v=>v.id===concert.venueId)?.name ?? '已刪除場地'} <br/>
          票數: ${t.quantity} 張
          ${t.status === 'refund_pending' ? `<div class="info" style="color:#e67e22;">退票審核中 (${t.refundRequest} 張)</div>` : ''}
        </div>
      `;
      // 只有正常票券可申請退票
      if(t.status !== 'refund_pending'){
        const refundBtn = document.createElement('button');
        refundBtn.className = 'small-btn';
        refundBtn.textContent = '退票';
        refundBtn.onclick = () => {
          showRefundModal(t, concert);
        };
        li.appendChild(refundBtn);
      }
      ul.appendChild(li);
    });
  }

  // Modal buy tickets
  function showBuyTicketModal(concert){
    const modal = createModal();
    const ticketsLeft = concert.ticketsAvailable - concert.ticketsSold;
    modal.box.innerHTML = `
      <h3>購買票券 - ${concert.title}</h3>
      <p>票價：NT$${concert.price}</p>
      <label for="ticketQuantity">購買數量 (剩餘 ${ticketsLeft} 張)</label>
      <input type="number" id="ticketQuantity" min="1" max="${ticketsLeft}" value="1" style="width:100%; padding:0.5rem; font-size:1rem;" />
      <label for="payMethod" style="margin-top:1rem;">選擇支付方式</label>
      <select id="payMethod" style="width:100%; margin-top:0.25rem;">
        <option value="credit">信用卡</option>
        <option value="linepay">Line Pay</option>
        <option value="atm">ATM轉帳</option>
      </select>
      <div id="payFields" style="margin-top:1rem;"></div>
      <p id="buyError" class="error" style="display:none;"></p>
      <div style="margin-top:1rem; text-align:right;">
        <button id="cancelBtn" style="margin-right:0.5rem; background:#888;">取消</button>
        <button id="confirmBtn">確定購買</button>
      </div>
    `;

    function renderPayFields() {
      const method = modal.box.querySelector('#payMethod').value;
      const payFields = modal.box.querySelector('#payFields');
      if(method === 'credit'){
        payFields.innerHTML = `
          <label for="cardNum">信用卡號</label>
          <input type="text" id="cardNum" maxlength="16" placeholder="請輸入16位數字" />
          <label for="cardExp">有效期限(月/年)</label>
          <input type="text" id="cardExp" maxlength="5" placeholder="MM/YY" />
          <label for="cardCVC">安全碼</label>
          <input type="text" id="cardCVC" maxlength="3" placeholder="CVC" />
        `;
      } else if(method === 'linepay'){
        payFields.innerHTML = `
          <label for="lineId">Line Pay 帳號</label>
          <input type="text" id="lineId" placeholder="請輸入Line Pay帳號" />
        `;
      } else if(method === 'atm'){
        // 假銀行資訊
        payFields.innerHTML = `
          <div id="atmInfo" style="background:#f0f0f0; padding:1rem; border-radius:8px; margin-bottom:1rem;">
            <strong>銀行代碼：</strong> 822<br>
            <strong>轉帳帳號：</strong> 1234-5678-9000-8888
          </div>
        `;
      }
    }
    renderPayFields();
    modal.box.querySelector('#payMethod').onchange = renderPayFields;

    modal.cancelBtn.onclick = () => {
      removeModal(modal.overlay);
    };

    modal.confirmBtn.onclick = () => {
      const quantity = parseInt(modal.box.querySelector('#ticketQuantity').value);
      const buyError = modal.box.querySelector('#buyError');
      const method = modal.box.querySelector('#payMethod').value;
      buyError.style.display = 'none';

      if(isNaN(quantity) || quantity<1){
        buyError.textContent = '請輸入有效購買數量';
        buyError.style.display = 'block';
        return;
      }
      if(quantity > ticketsLeft){
        buyError.textContent = `最多可購買 ${ticketsLeft} 張票`;
        buyError.style.display = 'block';
        return;
      }

      if(method === 'credit'){
        const cardNum = modal.box.querySelector('#cardNum').value.trim();
        const cardExp = modal.box.querySelector('#cardExp').value.trim();
        const cardCVC = modal.box.querySelector('#cardCVC').value.trim();
        if(!/^\d{16}$/.test(cardNum)){
          buyError.textContent = '請輸入正確的16位數信用卡號';
          buyError.style.display = 'block';
          return;
        }
        if(!/^\d{2}\/\d{2}$/.test(cardExp)){
          buyError.textContent = '請輸入正確的有效期限 (MM/YY)';
          buyError.style.display = 'block';
          return;
        }
        if(!/^\d{3}$/.test(cardCVC)){
          buyError.textContent = '請輸入正確的安全碼';
          buyError.style.display = 'block';
          return;
        }
        // 直接完成購買
        finishPurchase();
      } else if(method === 'linepay'){
        const lineId = modal.box.querySelector('#lineId').value.trim();
        if(!lineId){
          buyError.textContent = '請輸入Line Pay帳號';
          buyError.style.display = 'block';
          return;
        }
        // 模擬跳轉
        modal.box.innerHTML = `
          <h3>Line Pay 支付</h3>
          <p>正在跳轉至Line Pay付款頁面...</p>
          <div class="info" style="margin-top:1rem;">請勿關閉視窗，付款完成後將自動返回。</div>
        `;
        setTimeout(() => {
          finishPurchase();
        }, 5000);
      } else if(method === 'atm'){
        // 顯示ATM資訊與立即繳費按鈕
        modal.box.innerHTML = `
          <h3>ATM 轉帳繳費</h3>
          <div style="background:#f0f0f0; padding:1rem; border-radius:8px; margin-bottom:1rem;">
            <strong>銀行代碼：</strong> 822<br>
            <strong>轉帳帳號：</strong> 1234-5678-9000-8888
          </div>
          <div class="info" style="margin-bottom:1rem;">請於期限內完成轉帳，否則訂單將自動取消。</div>
          <div style="text-align:right;">
            <button id="atmPayBtn" style="background:var(--primary-color);">立即繳費</button>
          </div>
        `;
        modal.box.querySelector('#atmPayBtn').onclick = function(){
          modal.box.innerHTML = `
            <h3>ATM 轉帳繳費</h3>
            <p>正在確認您的轉帳紀錄...</p>
            <div class="info" style="margin-top:1rem;">請勿關閉視窗，完成後將自動返回。</div>
          `;
          setTimeout(() => {
            finishPurchase();
          }, 5000);
        };
      }

      function finishPurchase(){
        concert.ticketsSold += quantity;
        let existing = tickets.find(t => t.username === currentUser.username && t.concertId === concert.id);
        if(existing){
          existing.quantity += quantity;
        } else {
          tickets.push({username: currentUser.username, concertId: concert.id, quantity, status: 'normal'});
        }
        saveData();
        renderConcertsForSpectator();
        renderMyTickets();
        alert(`成功購買 ${quantity} 張票券！`);
        removeModal(modal.overlay);
      }
    };
  }

  // Modal refund tickets
  function showRefundModal(ticket, concert){
    const modal = createModal();
    modal.box.innerHTML = `
      <h3>申請退票 - ${concert.title}</h3>
      <p>您擁有 ${ticket.quantity} 張票</p>
      <label for="refundQuantity">申請退票數量</label><br/>
      <input type="number" id="refundQuantity" min="1" max="${ticket.quantity}" value="1" style="width:100%; padding:0.5rem; font-size:1rem;" />
      <p id="refundError" class="error" style="display:none;"></p>
      <div style="margin-top:1rem; text-align:right;">
        <button id="cancelBtn" style="margin-right:0.5rem; background:#888;">取消</button>
        <button id="confirmBtn">送出退票申請</button>
      </div>
    `;
    modal.cancelBtn.onclick = () => {
      removeModal(modal.overlay);
    };
    modal.confirmBtn.onclick = () => {
      const quantity = parseInt(modal.box.querySelector('#refundQuantity').value);
      const refundError = modal.box.querySelector('#refundError');
      if(isNaN(quantity) || quantity < 1){
        refundError.textContent = '請輸入有效退票數量';
        refundError.style.display = 'block';
        return;
      }
      if(quantity > ticket.quantity){
        refundError.textContent = `最多可退票 ${ticket.quantity} 張`;
        refundError.style.display = 'block';
        return;
      }
      // 標記為待審核
      ticket.refundRequest = quantity;
      ticket.status = 'refund_pending';
      saveData();
      renderConcertsForSpectator();
      renderMyTickets();
      alert(`退票申請已送出，請等待審核`);
      removeModal(modal.overlay);
    };
  }

  // Admin refund review
  function renderRefundReview(){
    const container = document.getElementById('adminContent');
    container.innerHTML = `
      <h3>退票審核</h3>
      <ul class="tickets-list" id="refundList"></ul>
    `;
    const ul = document.getElementById('refundList');
    ul.innerHTML = '';
    tickets.filter(t=>t.status==='refund_pending').forEach(t=>{
      const concert = concerts.find(c=>c.id===t.concertId);
      if(!concert) return;
      const li = document.createElement('li');
      li.innerHTML = `
        <div style="flex-grow:1;">
          <strong>${concert.title}</strong><br/>
          申請人: ${t.username}<br/>
          申請退票數量: ${t.refundRequest} 張
        </div>
      `;
      const approveBtn = document.createElement('button');
      approveBtn.className = 'small-btn';
      approveBtn.textContent = '同意';
      approveBtn.onclick = () => {
        // 實際退票
        t.quantity -= t.refundRequest;
        const concertData = concerts.find(c => c.id === t.concertId);
        if(concertData){
          concertData.ticketsSold -= t.refundRequest;
          if(concertData.ticketsSold < 0) concertData.ticketsSold = 0;
        }
        if(t.quantity === 0){
          const idx = tickets.findIndex(x=>x===t);
          if(idx !== -1) tickets.splice(idx,1);
        } else {
          t.status = 'normal';
          delete t.refundRequest;
        }
        saveData();
        renderRefundReview();
      };
      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'small-btn';
      rejectBtn.style.background = '#888';
      rejectBtn.textContent = '拒絕';
      rejectBtn.onclick = () => {
        t.status = 'normal';
        delete t.refundRequest;
        saveData();
        renderRefundReview();
      };
      li.appendChild(approveBtn);
      li.appendChild(rejectBtn);
      ul.appendChild(li);
    });
  }

  // Modal utility functions
  function createModal(){
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    const box = document.createElement('div');
    box.className = 'modal-box';
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Buttons references for convenience
    return {
      overlay,
      box,
      get cancelBtn(){ return box.querySelector('#cancelBtn'); },
      get confirmBtn(){ return box.querySelector('#confirmBtn'); },
    };
  }
  function removeModal(modal){
    if(modal && modal.parentElement) {
      modal.parentElement.removeChild(modal);
    }
  }

  // Logout handler
  logoutBtn.addEventListener('click', () => {
    if(confirm('確定要登出嗎？')){
      clearLogin();
      renderLogin();
    }
  });

  // On load
  window.addEventListener('load', () => {
    loadLogin();
    loadData();
    if(currentUser){
      logoutBtn.style.display = 'inline-block';
      if(!currentRole){
        if(currentUser.roles.length === 1){
          currentRole = currentUser.roles[0];
          saveLogin();
          renderDashboard();
        } else {
          renderRoleSelection();
        }
      } else {
        renderDashboard();
      }
    } else {
      renderLogin();
    }
  });
</script>
</body>
</html>


